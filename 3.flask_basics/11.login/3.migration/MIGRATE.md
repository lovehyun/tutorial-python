# DB 스키마 변경에 따른 마이그레이션 처리

## 수동으로 작업하기
수동으로 SQLite3 명령어를 통해 마이그레이션 시 아래 명령어들을 필요에 따라 조합해서 사용한다.
```
-- 새로운 컬럼을 추가합니다.
ALTER TABLE user ADD COLUMN email VARCHAR(120);

-- 기존 데이터를 새로운 컬럼에 복사합니다.
UPDATE user SET password_hash = password;

-- 기존 컬럼을 삭제합니다.
ALTER TABLE user DROP COLUMN password;

-- RENAME 기능이 있는 경우에는 다음 명령어를 통해 컬럼명을 변경할 수 있습니다.
ALTER TABLE user RENAME COLUMN password TO password_hash;
```

## 자동 마이그레이션을 위한 flask_migrate 사용
### 이메일 추가

1. 사전 셋업
    ```
    from flask_migrate import Migrate

    migrate = Migrate(app, db)
    ```

    위와 같이 코드 내에 환경 셋업을 추가하고 `flask db init` 을 통해 초기화 한다.

2. 마이그레이션 준비
    ```
    flask db migrate -m "email added"
    ```

    마이그레이션을 위한 템플릿 파일을 생성 후 필요한 부분은 수정한다. (versions/xxxx_email_added.py)
    CONTRAINT 의 None 을 uq_user_email 등으로 이름 추가.

    ```
    def upgrade():
        # ### commands auto generated by Alembic - please adjust! ###
        with op.batch_alter_table('user', schema=None) as batch_op:
            batch_op.add_column(sa.Column('email', sa.String(length=120), nullable=True))
            batch_op.create_unique_constraint('uq_user_email', ['email'])

        # ### end Alembic commands ###


    def downgrade():
        # ### commands auto generated by Alembic - please adjust! ###
        with op.batch_alter_table('user', schema=None) as batch_op:
            batch_op.drop_constraint('uq_user_email', type_='unique')
            batch_op.drop_column('email')

        # ### end Alembic commands ###

    ```

3. 마이그레이션 실행
    ```
    flask db upgrade
    ```

4. 마이그레이션 내용 확인
    ```
    flask db history
    ```

5. 필요 시 다운그레이드
    ```
    flask db downgrade
    ```

### 암호 컬럼 변경

1. 마이그레이션 준비
    ```
    flask db migrate -m "password_hash updated"
    ```

2. 마이그레이션 코드 수정
    
    마이그레이션을 위한 템플릿 파일을 생성 후 필요한 부분은 수정한다. (versions/xxxx_password_hashed.py)
    구버전 password를 새로운 password_hash 로 변경하기 위한 코드 전체적으로 모두 구현

    SQLite 에서는 password_hash 를 NULLABLE 로 추가할 때 이슈가 발생하여, 두번에 걸쳐서 수정해야 함.
    
    flask db migrate -m "Add nullable password_hash column"

    ```
    from alembic import op
    import sqlalchemy as sa

    # Revision identifiers, used by Alembic.
    revision = '<revision_id>'
    down_revision = 'previous_revision_id'
    branch_labels = None
    depends_on = None

    def upgrade():
        # Add the new password_hash column as nullable
        with op.batch_alter_table('user') as batch_op:
            batch_op.add_column(sa.Column('password_hash', sa.String(length=120), nullable=True))

    def downgrade():
        with op.batch_alter_table('user') as batch_op:
            batch_op.drop_column('password_hash')
    ```

    flask db migrate -m "Update password_hash to NOT NULL and drop password column"

    ```
    from alembic import op
    import sqlalchemy as sa
    from sqlalchemy.sql import table, column
    from sqlalchemy import String, Integer
    from werkzeug.security import generate_password_hash

    # Revision identifiers, used by Alembic.
    revision = '<revision_id>'
    down_revision = '<previous_revision_id>'
    branch_labels = None
    depends_on = None

    # Define user table for update
    user_table = table('user',
        column('id', Integer),
        column('password', String),
        column('password_hash', String)
    )

    def upgrade():
        # Migrate the existing passwords to password_hash
        connection = op.get_bind()
        users = connection.execute(sa.select(user_table.c.id, user_table.c.password))
        for user in users:
            password_hash = generate_password_hash(user.password)
            connection.execute(
                user_table.update().where(user_table.c.id == user.id).values(password_hash=password_hash)
            )

        # Make password_hash column non-nullable and drop the old password column
        with op.batch_alter_table('user') as batch_op:
            batch_op.alter_column('password_hash', existing_type=sa.String(length=120), nullable=False)
            batch_op.drop_column('password')

    def downgrade():
        with op.batch_alter_table('user') as batch_op:
            batch_op.add_column(sa.Column('password', sa.String(length=120), nullable=False))
            batch_op.alter_column('password_hash', existing_type=sa.String(length=120), nullable=True)
            batch_op.drop_column('password_hash')

    ```

3. 마이그레이션 실행
    ```
    flask db upgrade
    ```

4. 마이그레이션 취소
   ```
   flask db downgrade
   ```
