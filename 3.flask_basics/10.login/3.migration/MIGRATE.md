# DB 스키마 변경에 따른 마이그레이션 처리

## 수동으로 작업하기
수동으로 SQLite3 명령어를 통해 마이그레이션 시 아래 명령어들을 필요에 따라 조합해서 사용한다.
```
-- 새로운 컬럼을 추가합니다.
ALTER TABLE user ADD COLUMN email VARCHAR(120);

-- 기존 데이터를 새로운 컬럼에 복사합니다.
UPDATE user SET password_hash = password;

-- 기존 컬럼을 삭제합니다.
ALTER TABLE user DROP COLUMN password;

-- RENAME 기능이 있는 경우에는 다음 명령어를 통해 컬럼명을 변경할 수 있습니다.
ALTER TABLE user RENAME COLUMN password TO password_hash;
```

## 자동 마이그레이션을 위한 flask_migrate 사용
### 이메일 추가

1. 사전 셋업
    ```
    from flask_migrate import Migrate

    migrate = Migrate(app, db)
    ```

    위와 같이 코드 내에 환경 셋업을 추가하고 `flask db init` 을 통해 초기화 한다.

2. 마이그레이션 준비
    ```
    flask db migrate -m "email added"
    ```

    마이그레이션을 위한 템플릿 파일을 생성 후 필요한 부분은 수정한다.

    sqlite3 를 사용하는 경우 일부 작업이 지원되지 않아, `migrate = Migrate(app, db, render_as_batch=True)` 명령어를 통해 배치로 작업을 수행해서 우회 하거나, 

    아니면 필요한 CONTRAINT 의 이슈가 되는 부분을 해결한다. (실제로 이메일 추가시에는 별다른 이슈 없음.)

    ```
    def upgrade():
        # ### commands auto generated by Alembic - please adjust! ###
        with op.batch_alter_table('user', schema=None) as batch_op:
            batch_op.add_column(sa.Column('email', sa.String(length=120), nullable=True))

        # ### end Alembic commands ###


    def downgrade():
        # ### commands auto generated by Alembic - please adjust! ###
        with op.batch_alter_table('user', schema=None) as batch_op:
            batch_op.drop_column('email')

        # ### end Alembic commands ###

    ```

1. 마이그레이션 실행
    ```
    flask db upgrade
    ```

2. 마이그레이션 내용 확인
    ```
    flask db history
    ```

3. 필요 시 다운그레이드
    ```
    flask db downgrade
    ```

### 암호 컬럼 변경

1. 마이그레이션 준비
    ```
    flask db migrage -m "password_hash updated"
    ```

2. 마이그레이션 코드 수정
    ```
    """password_hash updated

    Revision ID: d143bbb20f0f
    Revises: e8d07866f0fa
    Create Date: 2023-07-31 21:29:04.509808

    """
    from alembic import op
    import sqlalchemy.orm as sa
    from sqlalchemy.orm import Session
    from sqlalchemy import Column, String
    from werkzeug.security import generate_password_hash
    from app import User


    # revision identifiers, used by Alembic.
    revision = 'd143bbb20f0f'
    down_revision = 'e8d07866f0fa'
    branch_labels = None
    depends_on = None


    def upgrade():
        # Add password_hash column as nullable
        with op.batch_alter_table('user', schema=None) as batch_op:
            batch_op.add_column(Column('password_hash', String(length=120), nullable=True))

        # Retrieve users from the database and update password_hash
        bind = op.get_bind()
        session = Session(bind=bind)
        users = session.query(User).all()
        for user in users:
            user.password_hash = generate_password_hash(user.password)
            print(f"{user}, {user.username}, {user.password} -> {user.password_hash}")

        session.commit()
        session.close()

        # Set password_hash column as NOT NULL
        with op.batch_alter_table('user', schema=None) as batch_op:
            batch_op.alter_column('password_hash', nullable=False)


    def downgrade():
        with op.batch_alter_table('user', schema=None) as batch_op:
            # Drop the 'password_hash' column
            batch_op.drop_column('password_hash')

    ```

3. 마이그레이션 실행
    ```
    flask db upgrade
    ```

4. 마이그레이션 취소
   ```
   flask db downgrade
   ```
