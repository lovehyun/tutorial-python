{% extends "base.html" %}

{% block title %}ì‹œí—˜ ëª¨ë“œ - {{ file_info.original_filename }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2>ğŸ¯ ì‹œí—˜ ëª¨ë“œ</h2>
        <p class="text-muted mb-0">{{ file_info.original_filename }} ({{ questions|length }}ë¬¸ì œ)</p>
    </div>
    <div>
        <span id="timer" class="badge bg-info fs-6">00:00:00</span>
    </div>
</div>

<div class="alert alert-warning">
    <strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong>
    <ul class="mb-0">
        <li>ëª¨ë“  ë¬¸ì œë¥¼ í’€ê³  <strong>ì œì¶œ ë²„íŠ¼</strong>ì„ ëˆŒëŸ¬ì•¼ ì±„ì ë©ë‹ˆë‹¤.</li>
        <li>ì œì¶œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</li>
        <li>í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ë©´ ì§„í–‰ ìƒí™©ì´ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.</li>
    </ul>
</div>

<!-- ì§„í–‰ë¥  í‘œì‹œ -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center">
            <span>ì§„í–‰ë¥ </span>
            <span id="progress-text">0 / {{ questions|length }}</span>
        </div>
        <div class="progress mt-2">
            <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
    </div>
</div>

<form method="POST" action="{{ url_for('result.submit_quiz') }}" id="quiz-form">
    {% for question in questions %}
    <div class="card mb-4 question-card" data-question-id="{{ question.display_id }}">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5>ë¬¸ì œ {{ question.display_id }}</h5>
            <span class="badge bg-secondary" id="status-{{ question.display_id }}">ë¯¸ì™„ë£Œ</span>
        </div>
        <div class="card-body">
            <p class="fs-5 mb-4">{{ question.question }}</p>

            {% for choice in question.shuffled_choices %}
            <div class="form-check mb-3">
                <input class="form-check-input" type="radio" 
                       name="question_{{ question.display_id }}" 
                       id="q{{ question.display_id }}_{{ choice.display_index }}"
                       value="{{ choice.display_index }}"
                       onchange="updateProgress()">
                <label class="form-check-label w-100" for="q{{ question.display_id }}_{{ choice.display_index }}">
                    <div class="p-2 border rounded choice-label">
                        <strong>{{ choice.display_index }}.</strong> {{ choice.text }}
                    </div>
                </label>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endfor %}

    <!-- ì œì¶œ ë²„íŠ¼ -->
    <div class="text-center mb-5">
        <button type="button" class="btn btn-success btn-lg" onclick="submitQuiz()" id="submit-btn" disabled>
            ğŸ“ ì‹œí—˜ ì œì¶œí•˜ê¸°
        </button>
        <p class="text-muted mt-2">ëª¨ë“  ë¬¸ì œë¥¼ ì™„ë£Œí•˜ë©´ ì œì¶œ ë²„íŠ¼ì´ í™œì„±í™”ë©ë‹ˆë‹¤.</p>
    </div>
</form>

<!-- ì œì¶œ í™•ì¸ ëª¨ë‹¬ -->
<div class="modal fade" id="submitModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ì‹œí—˜ ì œì¶œ í™•ì¸</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>ì •ë§ ì‹œí—˜ì„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <p class="text-muted">ì œì¶œ í›„ì—ëŠ” ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                <div id="submit-summary"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-success" onclick="confirmSubmit()">ì œì¶œí•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script>
let startTime = new Date();
let timerInterval;

// íƒ€ì´ë¨¸ ì‹œì‘
function startTimer() {
    timerInterval = setInterval(function() {
        const now = new Date();
        const elapsed = Math.floor((now - startTime) / 1000);
        const hours = Math.floor(elapsed / 3600);
        const minutes = Math.floor((elapsed % 3600) / 60);
        const seconds = elapsed % 60;
        
        document.getElementById('timer').textContent = 
            String(hours).padStart(2, '0') + ':' + 
            String(minutes).padStart(2, '0') + ':' + 
            String(seconds).padStart(2, '0');
    }, 1000);
}

// ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
function updateProgress() {
    const totalQuestions = {{ questions|length }};
    const answeredQuestions = document.querySelectorAll('input[type="radio"]:checked').length;
    const progressPercent = (answeredQuestions / totalQuestions) * 100;
    
    document.getElementById('progress-bar').style.width = progressPercent + '%';
    document.getElementById('progress-text').textContent = answeredQuestions + ' / ' + totalQuestions;
    
    // ì™„ë£Œëœ ë¬¸ì œ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.question-card').forEach(card => {
        const questionId = card.dataset.questionId;
        const isAnswered = card.querySelector('input[type="radio"]:checked');
        const statusBadge = document.getElementById('status-' + questionId);
        
        if (isAnswered) {
            statusBadge.textContent = 'ì™„ë£Œ';
            statusBadge.className = 'badge bg-success';
        } else {
            statusBadge.textContent = 'ë¯¸ì™„ë£Œ';
            statusBadge.className = 'badge bg-secondary';
        }
    });
    
    // ì œì¶œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™”
    const submitBtn = document.getElementById('submit-btn');
    if (answeredQuestions === totalQuestions) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ğŸ“ ì‹œí—˜ ì œì¶œí•˜ê¸°';
    } else {
        submitBtn.disabled = true;
        submitBtn.textContent = `ğŸ“ ì‹œí—˜ ì œì¶œí•˜ê¸° (${totalQuestions - answeredQuestions}ë¬¸ì œ ë‚¨ìŒ)`;
    }
}

// ì œì¶œ í™•ì¸
function submitQuiz() {
    const answered = document.querySelectorAll('input[type="radio"]:checked').length;
    const total = {{ questions|length }};
    
    document.getElementById('submit-summary').innerHTML = 
        `<strong>ë‹µë³€í•œ ë¬¸ì œ:</strong> ${answered} / ${total}<br>` +
        `<strong>ì†Œìš” ì‹œê°„:</strong> ${document.getElementById('timer').textContent}`;
    
    new bootstrap.Modal(document.getElementById('submitModal')).show();
}

// ìµœì¢… ì œì¶œ
function confirmSubmit() {
    clearInterval(timerInterval);
    document.getElementById('quiz-form').submit();
}

// ì„ íƒì§€ ìŠ¤íƒ€ì¼ë§
document.addEventListener('DOMContentLoaded', function() {
    startTimer();
    
    // ì„ íƒì§€ í´ë¦­ ì‹œ ìŠ¤íƒ€ì¼ ë³€ê²½
    document.querySelectorAll('.form-check-input').forEach(radio => {
        radio.addEventListener('change', function() {
            // ê°™ì€ ë¬¸ì œì˜ ë‹¤ë¥¸ ì„ íƒì§€ë“¤ ìŠ¤íƒ€ì¼ ë¦¬ì…‹
            const questionName = this.name;
            document.querySelectorAll(`input[name="${questionName}"]`).forEach(otherRadio => {
                const label = otherRadio.nextElementSibling.querySelector('.choice-label');
                if (otherRadio.checked) {
                    label.classList.add('bg-primary', 'text-white');
                    label.classList.remove('bg-light');
                } else {
                    label.classList.add('bg-light');
                    label.classList.remove('bg-primary', 'text-white');
                }
            });
        });
    });
});

</script>
{% endblock %}
