{% extends "base.html" %}

{% block title %}í”„ë¡œí•„ - {{ current_user.username }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ğŸ‘¤ í”„ë¡œí•„</h2>
    <a href="{{ url_for('quiz.dashboard') }}" class="btn btn-secondary">â† ëŒ€ì‹œë³´ë“œ</a>
</div>

<div class="row">
    <!-- ì‚¬ìš©ì ì •ë³´ -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">ğŸ” ê³„ì • ì •ë³´</h5>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>ì‚¬ìš©ìëª…:</strong></div>
                    <div class="col-sm-8">{{ current_user.username }}</div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>ì´ë©”ì¼:</strong></div>
                    <div class="col-sm-8">
                        <span id="current-email">{{ current_user.email }}</span>
                        <button class="btn btn-outline-info btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#emailModal">ë³€ê²½</button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-sm-4"><strong>ë¹„ë°€ë²ˆí˜¸:</strong></div>
                    <div class="col-sm-8">
                        â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢
                        <button class="btn btn-outline-warning btn-sm ms-2" data-bs-toggle="modal" data-bs-target="#passwordModal">ë³€ê²½</button>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-4"><strong>íšŒì› ë“±ê¸‰:</strong></div>
                    <div class="col-sm-8">
                        {% if stats.quiz_count >= 50 %}
                            <span class="badge bg-danger">í€´ì¦ˆ ë§ˆìŠ¤í„°</span>
                        {% elif stats.quiz_count >= 20 %}
                            <span class="badge bg-warning">ê³ ê¸‰ ì‚¬ìš©ì</span>
                        {% elif stats.quiz_count >= 5 %}
                            <span class="badge bg-success">ì¤‘ê¸‰ ì‚¬ìš©ì</span>
                        {% else %}
                            <span class="badge bg-info">ì´ˆë³´ ì‚¬ìš©ì</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í™œë™ í†µê³„ -->
    <div class="col-md-6">
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0">ğŸ“Š í™œë™ í†µê³„</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="display-6 text-primary">{{ stats.file_count }}</div>
                        <p class="text-muted">ì—…ë¡œë“œí•œ íŒŒì¼</p>
                    </div>
                    <div class="col-6">
                        <div class="display-6 text-success">{{ stats.quiz_count }}</div>
                        <p class="text-muted">ì™„ë£Œí•œ ì‹œí—˜</p>
                    </div>
                </div>
                <hr>
                <div class="row text-center">
                    <div class="col-6">
                        <div class="display-6 text-warning">{{ stats.avg_score }}%</div>
                        <p class="text-muted">í‰ê·  ì ìˆ˜</p>
                    </div>
                    <div class="col-6">
                        <div class="display-6 text-danger">{{ stats.max_score }}%</div>
                        <p class="text-muted">ìµœê³  ì ìˆ˜</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ì´ë©”ì¼ ë³€ê²½ ëª¨ë‹¬ -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ“§ ì´ë©”ì¼ ë³€ê²½</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="emailForm">
                    <div class="mb-3">
                        <label for="newEmail" class="form-label">ìƒˆ ì´ë©”ì¼ ì£¼ì†Œ</label>
                        <input type="email" class="form-control" id="newEmail" required
                               placeholder="ìƒˆ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-info" onclick="changeEmail()">ë³€ê²½</button>
            </div>
        </div>
    </div>
</div>

<!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
<div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="passwordForm">
                    <div class="mb-3">
                        <label for="currentPassword" class="form-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" id="currentPassword" required
                               placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                    <div class="mb-3">
                        <label for="newPassword" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" class="form-control" id="newPassword" required minlength="6"
                               placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)">
                    </div>
                    <div class="mb-3">
                        <label for="confirmPassword" class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                        <input type="password" class="form-control" id="confirmPassword" required
                               placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-warning" onclick="changePassword()">ë³€ê²½</button>
            </div>
        </div>
    </div>
</div>

<script>
// ì´ë©”ì¼ ë³€ê²½
async function changeEmail() {
    const newEmail = document.getElementById('newEmail').value.trim();
    
    if (!newEmail) {
        alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const response = await fetch('/user/change_email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ new_email: newEmail })
        });
        
        const data = await response.json();
        
        if (data.success) {
            // ì„±ê³µ: í™”ë©´ì˜ ì´ë©”ì¼ ì—…ë°ì´íŠ¸
            document.getElementById('current-email').textContent = data.new_email;
            bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
            showAlert('success', data.message);
            document.getElementById('newEmail').value = '';
        } else {
            showAlert('danger', data.message);
        }
    } catch (error) {
        showAlert('danger', 'ì´ë©”ì¼ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
async function changePassword() {
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmPassword = document.getElementById('confirmPassword').value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        return;
    }
    
    if (newPassword.length < 6) {
        alert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
        return;
    }
    
    try {
        const response = await fetch('/user/change_password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                current_password: currentPassword,
                new_password: newPassword 
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('passwordModal')).hide();
            showAlert('success', data.message);
            document.getElementById('passwordForm').reset();
        } else {
            showAlert('danger', data.message);
        }
    } catch (error) {
        showAlert('danger', 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    }
}

// ì•Œë¦¼ í‘œì‹œ (ì¼ê´€ì„± ìˆê²Œ ìˆ˜ì •)
function showAlert(type, message) {
    // ê¸°ì¡´ ì»¤ìŠ¤í…€ ì•Œë¦¼ ì œê±°
    const existingCustomAlert = document.querySelector('.custom-alert');
    if (existingCustomAlert) {
        existingCustomAlert.remove();
    }
    
    // ê¸°ì¡´ Flask í”Œë˜ì‹œ ë©”ì‹œì§€ë„ ì œê±°
    const existingFlashAlert = document.querySelector('.alert');
    if (existingFlashAlert && existingFlashAlert.parentNode.classList.contains('container')) {
        existingFlashAlert.remove();
    }
    
    // ìƒˆ ì•Œë¦¼ì„ Flask í”Œë˜ì‹œ ë©”ì‹œì§€ì™€ ê°™ì€ ìœ„ì¹˜ì— ìƒì„±
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // ë©”ì¸ ì»¨í…Œì´ë„ˆì˜ ë§¨ ìœ„ì— ì¶”ê°€ (ë‹¤ë¥¸ í˜ì´ì§€ì™€ ë™ì¼)
    const container = document.querySelector('main.container');
    if (container) {
        // í”Œë˜ì‹œ ë©”ì‹œì§€ ì˜ì—­ ë‹¤ìŒì— ì¶”ê°€
        const firstChild = container.children[0];
        if (firstChild && firstChild.classList.contains('alert')) {
            // ê¸°ì¡´ í”Œë˜ì‹œ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ êµì²´
            container.replaceChild(alertDiv, firstChild);
        } else {
            // ì—†ìœ¼ë©´ ë§¨ ìœ„ì— ì¶”ê°€
            container.insertBefore(alertDiv, firstChild);
        }
    }
    
    // 5ì´ˆ í›„ ìë™ ì œê±°
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>

<!-- ì„±ì·¨ ë°°ì§€ -->
<div class="card mb-4">
    <div class="card-header bg-warning text-dark">
        <h5 class="mb-0">ğŸ† ì„±ì·¨ ë°°ì§€</h5>
    </div>
    <div class="card-body">
        <div class="row text-center">
            {% if stats.quiz_count >= 1 %}
            <div class="col-md-2 mb-3">
                <div class="badge-item">
                    <div class="badge bg-success badge-large">ğŸ¯</div>
                    <small class="d-block mt-1">ì²« ì‹œí—˜</small>
                </div>
            </div>
            {% endif %}
            
            {% if stats.quiz_count >= 10 %}
            <div class="col-md-2 mb-3">
                <div class="badge-item">
                    <div class="badge bg-primary badge-large">ğŸ“š</div>
                    <small class="d-block mt-1">ì—´ì •ì  í•™ìŠµì</small>
                </div>
            </div>
            {% endif %}
            
            {% if stats.max_score >= 90 %}
            <div class="col-md-2 mb-3">
                <div class="badge-item">
                    <div class="badge bg-warning badge-large">â­</div>
                    <small class="d-block mt-1">ì™„ë²½ì£¼ì˜ì</small>
                </div>
            </div>
            {% endif %}
            
            {% if stats.avg_score >= 80 %}
            <div class="col-md-2 mb-3">
                <div class="badge-item">
                    <div class="badge bg-info badge-large">ğŸ“</div>
                    <small class="d-block mt-1">ìš°ìˆ˜í•œ ì„±ì </small>
                </div>
            </div>
            {% endif %}
            
            {% if stats.file_count >= 5 %}
            <div class="col-md-2 mb-3">
                <div class="badge-item">
                    <div class="badge bg-secondary badge-large">ğŸ“</div>
                    <small class="d-block mt-1">íŒŒì¼ ë§ˆìŠ¤í„°</small>
                </div>
            </div>
            {% endif %}
            
            {% if stats.quiz_count >= 50 %}
            <div class="col-md-2 mb-3">
                <div class="badge-item">
                    <div class="badge bg-danger badge-large">ğŸ”¥</div>
                    <small class="d-block mt-1">í€´ì¦ˆ ë§ˆë‹ˆì•„</small>
                </div>
            </div>
            {% endif %}
        </div>
        
        {% if stats.quiz_count == 0 %}
        <div class="text-center text-muted">
            <p>ì•„ì§ íšë“í•œ ë°°ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            <p>ì‹œí—˜ì„ ì™„ë£Œí•˜ê³  ë°°ì§€ë¥¼ ìˆ˜ì§‘í•´ë³´ì„¸ìš”!</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- í•™ìŠµ ì§„í–‰ ìƒí™© -->
<div class="card mb-4">
    <div class="card-header bg-success text-white">
        <h5 class="mb-0">ğŸ“ˆ í•™ìŠµ ì§„í–‰ ìƒí™©</h5>
    </div>
    <div class="card-body">
        {% if stats.quiz_count > 0 %}
        <div class="row">
            <div class="col-md-6">
                <h6>ëª©í‘œ ë‹¬ì„±ë¥ </h6>
                <div class="mb-3">
                    <!-- ì‹œí—˜ íšŸìˆ˜ ì§„í–‰ë¥  -->
                    {% if stats.quiz_count < 10 %}
                        {% set target = 10 %}
                        {% set progress = (stats.quiz_count / target * 100) %}
                        <div class="d-flex justify-content-between mb-1">
                            <small>ì—´ì •ì  í•™ìŠµì ëª©í‘œ</small>
                            <small>{{ stats.quiz_count }} / {{ target }}íšŒ</small>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-primary" style="width: {{ progress }}%"></div>
                        </div>
                    {% elif stats.quiz_count < 50 %}
                        {% set target = 50 %}
                        {% set progress = (stats.quiz_count / target * 100) %}
                        <div class="d-flex justify-content-between mb-1">
                            <small>í€´ì¦ˆ ë§ˆë‹ˆì•„ ëª©í‘œ</small>
                            <small>{{ stats.quiz_count }} / {{ target }}íšŒ</small>
                        </div>
                        <div class="progress mb-2">
                            <div class="progress-bar bg-warning" style="width: {{ progress }}%"></div>
                        </div>
                    {% else %}
                        <div class="alert alert-success py-2 mb-2">
                            ğŸ† ëª¨ë“  ì‹œí—˜ íšŸìˆ˜ ëª©í‘œ ë‹¬ì„±!
                        </div>
                    {% endif %}
                    
                    <!-- í‰ê·  ì ìˆ˜ ì§„í–‰ë¥  -->
                    {% if stats.avg_score < 80 %}
                        {% set score_progress = (stats.avg_score / 80 * 100) %}
                        <div class="d-flex justify-content-between mb-1">
                            <small>í‰ê·  80ì  ëª©í‘œ</small>
                            <small>{{ stats.avg_score }}% / 80%</small>
                        </div>
                        <div class="progress">
                            <div class="progress-bar bg-success" style="width: {{ score_progress }}%"></div>
                        </div>
                    {% else %}
                        <div class="alert alert-success py-2">
                            ğŸ¯ í‰ê·  ì ìˆ˜ ëª©í‘œ ë‹¬ì„±!
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-6">
                <h6>ë‹¤ìŒ ëª©í‘œ</h6>
                <div class="list-unstyled">
                    {% if stats.quiz_count < 5 %}
                        <li class="mb-2">ğŸ¯ ì¤‘ê¸‰ ì‚¬ìš©ìê¹Œì§€ <strong>{{ 5 - stats.quiz_count }}íšŒ</strong> ë‚¨ìŒ</li>
                    {% elif stats.quiz_count < 10 %}
                        <li class="mb-2">ğŸ“š ì—´ì •ì  í•™ìŠµìê¹Œì§€ <strong>{{ 10 - stats.quiz_count }}íšŒ</strong> ë‚¨ìŒ</li>
                    {% elif stats.quiz_count < 20 %}
                        <li class="mb-2">ğŸ“ ê³ ê¸‰ ì‚¬ìš©ìê¹Œì§€ <strong>{{ 20 - stats.quiz_count }}íšŒ</strong> ë‚¨ìŒ</li>
                    {% elif stats.quiz_count < 50 %}
                        <li class="mb-2">ğŸ”¥ í€´ì¦ˆ ë§ˆë‹ˆì•„ê¹Œì§€ <strong>{{ 50 - stats.quiz_count }}íšŒ</strong> ë‚¨ìŒ</li>
                    {% else %}
                        <li class="mb-2">ğŸ† ëª¨ë“  ëª©í‘œë¥¼ ë‹¬ì„±í–ˆìŠµë‹ˆë‹¤!</li>
                    {% endif %}
                    
                    {% if stats.avg_score < 80 %}
                        <li class="mb-2">ğŸ’ª í‰ê·  80ì ê¹Œì§€ <strong>{{ "%.1f"|format(80 - stats.avg_score) }}ì </strong> ìƒìŠ¹ í•„ìš”</li>
                    {% endif %}
                    
                    {% if stats.max_score < 90 %}
                        <li class="mb-2">â­ ì™„ë²½ì£¼ì˜ì ë°°ì§€ë¥¼ ìœ„í•´ <strong>90ì  ì´ìƒ</strong> ë„ì „!</li>
                    {% endif %}
                </div>
            </div>
        </div>
        {% else %}
        <div class="text-center text-muted py-4">
            <h6>ì•„ì§ ì‹œí—˜ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤</h6>
            <p>ì²« ì‹œí—˜ì„ ì™„ë£Œí•˜ê³  í•™ìŠµ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•´ë³´ì„¸ìš”!</p>
            <a href="{{ url_for('quiz.dashboard') }}" class="btn btn-primary">ì‹œí—˜ ë³´ëŸ¬ ê°€ê¸°</a>
        </div>
        {% endif %}
    </div>
</div>

<!-- ë¹ ë¥¸ ì•¡ì…˜ -->
<div class="card">
    <div class="card-header bg-light">
        <h5 class="mb-0">ğŸš€ ë¹ ë¥¸ ì•¡ì…˜</h5>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-3 mb-2">
                <a href="{{ url_for('quiz.dashboard') }}" class="btn btn-outline-primary w-100">
                    ğŸ  ëŒ€ì‹œë³´ë“œ
                </a>
            </div>
            <div class="col-md-3 mb-2">
                <a href="{{ url_for('result.stats') }}" class="btn btn-outline-info w-100">
                    ğŸ“Š í†µê³„ ë³´ê¸°
                </a>
            </div>
            <div class="col-md-3 mb-2">
                <a href="{{ url_for('result.history') }}" class="btn btn-outline-success w-100">
                    ğŸ“‹ ì‹œí—˜ ê¸°ë¡
                </a>
            </div>
            <div class="col-md-3 mb-2">
                <a href="{{ url_for('quiz.settings') }}" class="btn btn-outline-secondary w-100">
                    âš™ï¸ ì„¤ì •
                </a>
            </div>
        </div>
    </div>
</div>

<style>
.badge-large {
    font-size: 2rem;
    padding: 1rem;
    border-radius: 50%;
    width: 60px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.badge-item {
    display: flex;
    flex-direction: column;
    align-items: center;
}

.progress-stacked {
    display: flex;
    border-radius: 0.375rem;
    overflow: hidden;
}

.progress-stacked .progress {
    background-color: transparent;
}

.progress-stacked .progress-bar {
    font-size: 0.75rem;
    line-height: 20px;
    text-align: center;
}
</style>
{% endblock %}
