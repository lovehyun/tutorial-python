{% extends "base.html" %}

{% block title %}í†µê³„ ëŒ€ì‹œë³´ë“œ - í€´ì¦ˆ ì•±{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ğŸ“Š í†µê³„ ëŒ€ì‹œë³´ë“œ</h2>
    <a href="{{ url_for('quiz.dashboard') }}" class="btn btn-secondary">â† ëŒ€ì‹œë³´ë“œ</a>
</div>

<!-- í•„í„° ë²„íŠ¼ -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-center gap-2 flex-wrap">
            <button class="btn btn-outline-primary filter-btn active" data-period="recent10">
                ìµœê·¼ 10íšŒ
            </button>
            <button class="btn btn-outline-primary filter-btn" data-period="recent30">
                ìµœê·¼ 30íšŒ
            </button>
            <button class="btn btn-outline-primary filter-btn" data-period="last30days">
                ìµœê·¼ 30ì¼
            </button>
            <button class="btn btn-outline-primary filter-btn" data-period="all">
                ì „ì²´
            </button>
        </div>
    </div>
</div>

<!-- í†µê³„ ìš”ì•½ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-6 text-primary" id="stat-count">-</div>
                <p class="card-text">ì‹œí—˜ íšŸìˆ˜</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-6 text-success" id="stat-average">-</div>
                <p class="card-text">í‰ê·  ì ìˆ˜</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-6 text-warning" id="stat-max">-</div>
                <p class="card-text">ìµœê³  ì ìˆ˜</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-6 text-danger" id="stat-min">-</div>
                <p class="card-text">ìµœì € ì ìˆ˜</p>
            </div>
        </div>
    </div>
</div>

<!-- ì°¨íŠ¸ ì˜ì—­ -->
<div class="card mb-4">
    <div class="card-header">
        <h5 id="chart-title">ì ìˆ˜ ì¶”ì´ - ìµœê·¼ 10íšŒ</h5>
    </div>
    <div class="card-body">
        <div class="chart-container" style="position: relative; height: 400px;">
            <canvas id="scoreChart"></canvas>
        </div>
    </div>
</div>

<!-- ë¡œë”© í‘œì‹œ -->
<div id="loading" class="text-center" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">ë¡œë”©ì¤‘...</span>
    </div>
    <p class="mt-2">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
</div>

<!-- ë°ì´í„° ì—†ìŒ í‘œì‹œ -->
<div id="no-data" class="text-center py-5" style="display: none;">
    <div class="alert alert-info">
        <div class="display-1 text-muted mb-4">ğŸ“Š</div>
        <h4>í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
        <p class="text-muted mb-4">
            ì•„ì§ ì™„ë£Œí•œ ì‹œí—˜ì´ ì—†ì–´ì„œ í‘œì‹œí•  í†µê³„ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
            ì²« ì‹œí—˜ì„ ì™„ë£Œí•˜ë©´ ì—¬ê¸°ì— ì ìˆ˜ ì¶”ì´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”!
        </p>
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <a href="{{ url_for('quiz.dashboard') }}" class="btn btn-primary">
                ğŸ¯ ì²« ì‹œí—˜ ë³´ëŸ¬ ê°€ê¸°
            </a>
        </div>
    </div>
</div>

<script>
let scoreChart = null;
let currentPeriod = 'recent10';

// ì°¨íŠ¸ ì´ˆê¸°í™”
function initChart() {
    const ctx = document.getElementById('scoreChart').getContext('2d');
    scoreChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [{
                label: 'ì ìˆ˜',
                data: [],
                borderColor: 'rgb(75, 192, 192)',
                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                tension: 0.1,
                fill: true
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                title: {
                    display: true,
                    text: 'ì‹œí—˜ ì ìˆ˜ ì¶”ì´'
                },
                legend: {
                    display: false
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + '%';
                        }
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'ì‹œí—˜ ìˆœì„œ'
                    }
                }
            },
            elements: {
                point: {
                    radius: 6,
                    hoverRadius: 8
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });
}

// í†µê³„ ë°ì´í„° ë¡œë“œ
async function loadStats(period) {
    showLoading(true);
    showNoData(false);
    showChart(false);
    
    try {
        const response = await fetch(`/result/api/stats/${period}`);
        const data = await response.json();
        
        if (data.data.length === 0) {
            showNoData(true);
            showChart(false);
            // í†µê³„ ìš”ì•½ë„ ì´ˆê¸°í™”
            updateStats({count: 0, average: 0, max: 0, min: 0});
        } else {
            showNoData(false);
            showChart(true);
            updateChart(data);
            updateStats(data.stats);
        }
        
        updateChartTitle(period);
    } catch (error) {
        console.error('í†µê³„ ë¡œë“œ ì‹¤íŒ¨:', error);
        showNoData(true);
        showChart(false);
        // ì‚¬ìš©ìì—ê²Œ ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ (íŒì—… ëŒ€ì‹  í˜ì´ì§€ ë‚´ í‘œì‹œ)
        document.getElementById('no-data').innerHTML = `
            <div class="alert alert-danger">
                <h5>ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h5>
                <p>ì„œë²„ì™€ì˜ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                <button class="btn btn-outline-danger" onclick="loadStats('${period}')">ë‹¤ì‹œ ì‹œë„</button>
            </div>
        `;
        updateStats({count: 0, average: 0, max: 0, min: 0});
    } finally {
        showLoading(false);
    }
}

// ì°¨íŠ¸ ì—…ë°ì´íŠ¸
function updateChart(data) {
    const chartData = data.data;
    
    scoreChart.data.labels = chartData.map((_, index) => `${index + 1}íšŒ`);
    scoreChart.data.datasets[0].data = chartData.map(item => item.y);
    
    // ì ìˆ˜ì— ë”°ë¥¸ ìƒ‰ìƒ ë³€ê²½
    const colors = chartData.map(item => {
        if (item.y >= 80) return 'rgba(40, 167, 69, 0.8)';  // ì´ˆë¡
        if (item.y >= 60) return 'rgba(255, 193, 7, 0.8)';   // ë…¸ë‘
        return 'rgba(220, 53, 69, 0.8)';  // ë¹¨ê°•
    });
    
    scoreChart.data.datasets[0].backgroundColor = colors;
    scoreChart.data.datasets[0].borderColor = colors.map(color => color.replace('0.8', '1'));
    
    scoreChart.update();
}

// í†µê³„ ìš”ì•½ ì—…ë°ì´íŠ¸
function updateStats(stats) {
    document.getElementById('stat-count').textContent = stats.count || 0;
    document.getElementById('stat-average').textContent = (stats.average || 0) + '%';
    document.getElementById('stat-max').textContent = (stats.max || 0) + '%';
    document.getElementById('stat-min').textContent = (stats.min || 0) + '%';
}

// ì°¨íŠ¸ ì œëª© ì—…ë°ì´íŠ¸
function updateChartTitle(period) {
    const titles = {
        'recent10': 'ì ìˆ˜ ì¶”ì´ - ìµœê·¼ 10íšŒ',
        'recent30': 'ì ìˆ˜ ì¶”ì´ - ìµœê·¼ 30íšŒ',
        'last30days': 'ì ìˆ˜ ì¶”ì´ - ìµœê·¼ 30ì¼',
        'all': 'ì ìˆ˜ ì¶”ì´ - ì „ì²´'
    };
    document.getElementById('chart-title').textContent = titles[period];
}

// UI ì œì–´ í•¨ìˆ˜ë“¤
function showLoading(show) {
    document.getElementById('loading').style.display = show ? 'block' : 'none';
}

function showNoData(show) {
    document.getElementById('no-data').style.display = show ? 'block' : 'none';
}

function showChart(show) {
    document.querySelector('.card .card-body .chart-container').parentElement.parentElement.style.display = 
        show ? 'block' : 'none';
}

// í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        // í™œì„± ë²„íŠ¼ ë³€ê²½
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // ë°ì´í„° ë¡œë“œ
        currentPeriod = this.dataset.period;
        loadStats(currentPeriod);
    });
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', function() {
    initChart();
    loadStats(currentPeriod);
});
</script>
{% endblock %}
