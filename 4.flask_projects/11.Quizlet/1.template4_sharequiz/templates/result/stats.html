{% extends "base.html" %}

{% block title %}í†µê³„ ëŒ€ì‹œë³´ë“œ - í€´ì¦ˆ ì•±{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>ğŸ“Š í†µê³„ ëŒ€ì‹œë³´ë“œ</h2>
    <a href="{{ url_for('quiz.dashboard') }}" class="btn btn-secondary">â† ëŒ€ì‹œë³´ë“œ</a>
</div>

<!-- í•„í„° ë²„íŠ¼ -->
<div class="card mb-4">
    <div class="card-body">
        <div class="d-flex justify-content-center gap-2 flex-wrap">
            <a href="{{ url_for('result.stats', period='recent10') }}" class="btn btn-outline-primary {% if period == 'recent10' %}active{% endif %}">ìµœê·¼ 10íšŒ</a>
            <a href="{{ url_for('result.stats', period='recent30') }}" class="btn btn-outline-primary {% if period == 'recent30' %}active{% endif %}">ìµœê·¼ 30íšŒ</a>
            <a href="{{ url_for('result.stats', period='last30days') }}" class="btn btn-outline-primary {% if period == 'last30days' %}active{% endif %}">ìµœê·¼ 30ì¼</a>
            <a href="{{ url_for('result.stats', period='all') }}" class="btn btn-outline-primary {% if period == 'all' %}active{% endif %}">ì „ì²´</a>
        </div>
    </div>
</div>

{% if data|length == 0 %}
<!-- ë°ì´í„° ì—†ìŒ í‘œì‹œ -->
<div id="no-data" class="text-center py-5">
    <div class="alert alert-info">
        <div class="display-1 text-muted mb-4">ğŸ“Š</div>
        <h4>í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤</h4>
        <p class="text-muted mb-4">
            ì•„ì§ ì™„ë£Œí•œ ì‹œí—˜ì´ ì—†ì–´ì„œ í‘œì‹œí•  í†µê³„ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
            ì²« ì‹œí—˜ì„ ì™„ë£Œí•˜ë©´ ì—¬ê¸°ì— ì ìˆ˜ ì¶”ì´ë¥¼ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”!
        </p>
        <div class="d-grid gap-2 d-md-flex justify-content-md-center">
            <a href="{{ url_for('quiz.dashboard') }}" class="btn btn-primary">
                ğŸ¯ ì²« ì‹œí—˜ ë³´ëŸ¬ ê°€ê¸°
            </a>
        </div>
    </div>
</div>
{% else %}
<!-- í†µê³„ ìš”ì•½ -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-6 text-primary">{{ stats.count }}</div>
                <p class="card-text">ì‹œí—˜ íšŸìˆ˜</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-6 text-success">{{ stats.average }}%</div>
                <p class="card-text">í‰ê·  ì ìˆ˜</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-6 text-warning">{{ stats.max }}%</div>
                <p class="card-text">ìµœê³  ì ìˆ˜</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <div class="display-6 text-danger">{{ stats.min }}%</div>
                <p class="card-text">ìµœì € ì ìˆ˜</p>
            </div>
        </div>
    </div>
</div>

<!-- ê·¸ë˜í”„ ìœ í˜• ì „í™˜ ë²„íŠ¼ -->
<div class="text-end mb-3">
    <button class="btn btn-outline-secondary" onclick="toggleChartType()">
        ğŸ”„ ê·¸ë˜í”„ ìœ í˜• ì „í™˜ (í˜„ì¬: <span id="chartTypeLabel">ë¼ì¸</span>)
    </button>
</div>

<!-- ì°¨íŠ¸ ì˜ì—­ -->
<div class="card mb-4">
    <div class="card-header">
        <h5>
            {% if period == 'recent10' %}ì ìˆ˜ ì¶”ì´ - ìµœê·¼ 10íšŒ{% elif period == 'recent30' %}ì ìˆ˜ ì¶”ì´ - ìµœê·¼ 30íšŒ
            {% elif period == 'last30days' %}ì ìˆ˜ ì¶”ì´ - ìµœê·¼ 30ì¼{% else %}ì ìˆ˜ ì¶”ì´ - ì „ì²´{% endif %}
        </h5>
    </div>
    <div class="card-body">
        <div class="chart-container" style="position: relative; height: 400px;">
            <canvas id="scoreChart"></canvas>
        </div>
    </div>
</div>

<!-- ì°¨íŠ¸ ë Œë”ë§ -->
<script>
    const labels = {{ data|map(attribute='x')|list|tojson }}; // ë°ì´í„° í¬ë©§ì„ json list í˜•íƒœë¡œ ì „ë‹¬
    const scores = {{ data|map(attribute='y')|list }};
    const colors = scores.map(score => {
        if (score >= 80) return 'rgba(40, 167, 69, 0.8)';
        if (score >= 60) return 'rgba(255, 193, 7, 0.8)';
        return 'rgba(220, 53, 69, 0.8)';
    });

    let currentChartType = 'line';

    const ctx = document.getElementById('scoreChart').getContext('2d');
    const scoreChart = new Chart(ctx, {
        type: currentChartType,
        data: {
            labels: labels,
            datasets: [{
                label: 'ì ìˆ˜',
                data: scores,
                backgroundColor: colors,
                borderColor: colors.map(c => c.replace('0.8', '1')),
                fill: true,
                tension: 0.1,
                pointRadius: 6,
                pointHoverRadius: 8
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: value => value + '%'
                    }
                },
                x: {
                    title: {
                        display: true,
                        text: 'ì‹œí—˜ ë‚ ì§œ'
                    },
                    ticks: {
                        maxRotation: 45,
                        minRotation: 20
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: 'ì‹œí—˜ ì ìˆ˜ ì¶”ì´'
                },
                legend: {
                    display: false
                }
            },
            interaction: {
                intersect: false,
                mode: 'index'
            }
        }
    });

    function toggleChartType() {
        currentChartType = currentChartType === 'line' ? 'bar' : 'line';
        scoreChart.config.type = currentChartType;

        // barThickness ì¡°ê±´ë¶€ ì„¤ì •
        const dataset = scoreChart.data.datasets[0];
        if (currentChartType === 'bar') {
           dataset.borderWidth = 2;  // ë°” í…Œë‘ë¦¬ ë‘ê»˜
        } else {
            delete dataset.borderWidth;  // ì„ í˜•ì—ì„œëŠ” ì œê±°
        }

        // xì¶• ë ˆì´ë¸” ìœ„ì¹˜ ì¡°ì •
        scoreChart.options.scales.x.offset = currentChartType === 'bar';

        scoreChart.update();
        document.getElementById('chartTypeLabel').textContent = currentChartType === 'line' ? 'ë¼ì¸' : 'ë§‰ëŒ€';
    }
</script>
{% endif %}
{% endblock %}
