{% extends "base.html" %}

{% block title %}ê´€ë¦¬ì - ì‚¬ìš©ì ê´€ë¦¬{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-warning">ğŸ‘¥ ì‚¬ìš©ì ê´€ë¦¬</h2>
    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary">â† ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</a>
</div>

<div class="card">
    <div class="card-header bg-light"><h5 class="mb-0">ì „ì²´ ì‚¬ìš©ì ({{ users|length }})</h5></div>
    <div class="card-body">
        <div class="mb-3 text-end">
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addUserModal">+ ì‚¬ìš©ì ì¶”ê°€</button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>ê°€ì…ì¼</th>
                        <th>ìµœê·¼ ë¡œê·¸ì¸</th>
                        <th>ë¡œê·¸ì¸ íšŸìˆ˜</th>
                        <th>ê¶Œí•œ</th>
                        <th>ì‘ì—…</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td>{{ u.id }}</td>
                        <td>{{ u.username }}</td>
                        <td>
                            {{ u.email }}
                            <button class="btn btn-sm btn-outline-primary ms-2" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#editEmailModal"
                                    data-user-id="{{ u.id }}"
                                    data-username="{{ u.username }}"
                                    data-email="{{ u.email }}">ìˆ˜ì •</button>
                        </td>
                        <td><small class="text-muted">{{ u.created_at }}</small></td>
                        <td><small class="text-muted">{{ u.last_login_at or '-' }}</small></td>
                        <td><span class="badge bg-info">{{ u.login_count or 0 }}</span></td>
                        <td>
                            {% if u.is_admin %}
                                <span class="badge bg-warning text-dark">ADMIN</span>
                            {% else %}
                                <span class="badge bg-secondary">USER</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#editPwModal"
                                        data-user-id="{{ u.id }}" data-username="{{ u.username }}">ë¹„ë²ˆ ë³€ê²½</button>
                                <form method="post" action="{{ url_for('admin.admin_delete_user', user_id=u.id) }}" onsubmit="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')">
                                    <button class="btn btn-outline-danger" type="submit">ì‚­ì œ</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- ì‚¬ìš©ì ì¶”ê°€ ëª¨ë‹¬ -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" method="post" action="{{ url_for('admin.admin_add_user') }}">
            <div class="modal-header">
                <h5 class="modal-title">ì‚¬ìš©ì ì¶”ê°€</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">ì‚¬ìš©ìëª…</label>
                    <input type="text" name="username" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">ì´ë©”ì¼</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">ì„ì‹œ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" name="password" class="form-control" minlength="6" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-warning">ì¶”ê°€</button>
            </div>
        </form>
    </div>
    </div>

{% if total_pages and total_pages > 1 %}
<nav aria-label="í˜ì´ì§€" class="mt-3">
    <ul class="pagination justify-content-center">
        {% if has_prev %}
        <li class="page-item"><a class="page-link" href="{{ url_for('admin.admin_users', page=page-1) }}">ì´ì „</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">{{ page }} / {{ total_pages }}</span></li>
        {% if has_next %}
        <li class="page-item"><a class="page-link" href="{{ url_for('admin.admin_users', page=page+1) }}">ë‹¤ìŒ</a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}
<!-- ë‹¨ì¼ ì´ë©”ì¼ ìˆ˜ì • ëª¨ë‹¬ (ë™ì  ë°”ì¸ë”©) -->
<div class="modal fade" id="editEmailModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="editEmailForm" class="modal-content" method="post">
            <div class="modal-header">
                <h5 class="modal-title" id="editEmailTitle">ì´ë©”ì¼ ìˆ˜ì •</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">ìƒˆ ì´ë©”ì¼</label>
                <input type="email" name="email" id="editEmailInput" class="form-control" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-primary">ì €ì¥</button>
            </div>
        </form>
    </div>
</div>

<!-- ë‹¨ì¼ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ (ë™ì  ë°”ì¸ë”©) -->
<div class="modal fade" id="editPwModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="editPwForm" class="modal-content" method="post">
            <div class="modal-header">
                <h5 class="modal-title" id="editPwTitle">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" name="password" class="form-control mb-2" minlength="6" required>
                <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                <input type="password" name="password_confirm" class="form-control" minlength="6" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="submit" class="btn btn-success">ì €ì¥</button>
            </div>
        </form>
    </div>
</div>

{% block extra_scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var emailModal = document.getElementById('editEmailModal');
    emailModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var userId = button.getAttribute('data-user-id');
        var username = button.getAttribute('data-username');
        var email = button.getAttribute('data-email');
        document.getElementById('editEmailTitle').textContent = 'ì´ë©”ì¼ ìˆ˜ì • - ' + username;
        document.getElementById('editEmailInput').value = email || '';
        var form = document.getElementById('editEmailForm');
        form.action = '{{ url_for('admin.admin_update_email', user_id=0) }}'.replace('/0/', '/' + userId + '/');
    });

    var pwModal = document.getElementById('editPwModal');
    pwModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var userId = button.getAttribute('data-user-id');
        var username = button.getAttribute('data-username');
        document.getElementById('editPwTitle').textContent = 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ - ' + username;
        var form = document.getElementById('editPwForm');
        form.action = '{{ url_for('admin.admin_update_password', user_id=0) }}'.replace('/0/', '/' + userId + '/');
    });
});
</script>
{% endblock %}
{% endblock %}


