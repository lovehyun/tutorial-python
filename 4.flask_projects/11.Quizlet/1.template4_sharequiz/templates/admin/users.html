{% extends "base.html" %}

{% block title %}관리자 - 사용자 관리{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-warning">👥 사용자 관리</h2>
    <a href="{{ url_for('admin.admin_dashboard') }}" class="btn btn-secondary">← 관리자 대시보드</a>
</div>

<div class="card">
    <div class="card-header bg-light"><h5 class="mb-0">전체 사용자 ({{ users|length }})</h5></div>
    <div class="card-body">
        <div class="mb-3 text-end">
            <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addUserModal">+ 사용자 추가</button>
        </div>
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Username</th>
                        <th>Email</th>
                        <th>가입일</th>
                        <th>최근 로그인</th>
                        <th>로그인 횟수</th>
                        <th>권한</th>
                        <th>작업</th>
                    </tr>
                </thead>
                <tbody>
                    {% for u in users %}
                    <tr>
                        <td>{{ u.id }}</td>
                        <td>{{ u.username }}</td>
                        <td>
                            {{ u.email }}
                            <button class="btn btn-sm btn-outline-primary ms-2" 
                                    data-bs-toggle="modal" 
                                    data-bs-target="#editEmailModal"
                                    data-user-id="{{ u.id }}"
                                    data-username="{{ u.username }}"
                                    data-email="{{ u.email }}">수정</button>
                        </td>
                        <td><small class="text-muted">{{ u.created_at }}</small></td>
                        <td><small class="text-muted">{{ u.last_login_at or '-' }}</small></td>
                        <td><span class="badge bg-info">{{ u.login_count or 0 }}</span></td>
                        <td>
                            {% if u.is_admin %}
                                <span class="badge bg-warning text-dark">ADMIN</span>
                            {% else %}
                                <span class="badge bg-secondary">USER</span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-success" data-bs-toggle="modal" data-bs-target="#editPwModal"
                                        data-user-id="{{ u.id }}" data-username="{{ u.username }}">비번 변경</button>
                                <form method="post" action="{{ url_for('admin.admin_delete_user', user_id=u.id) }}" onsubmit="return confirm('정말 삭제하시겠습니까?')">
                                    <button class="btn btn-outline-danger" type="submit">삭제</button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 사용자 추가 모달 -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog">
        <form class="modal-content" method="post" action="{{ url_for('admin.admin_add_user') }}">
            <div class="modal-header">
                <h5 class="modal-title">사용자 추가</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">사용자명</label>
                    <input type="text" name="username" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">이메일</label>
                    <input type="email" name="email" class="form-control" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">임시 비밀번호</label>
                    <input type="password" name="password" class="form-control" minlength="6" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="submit" class="btn btn-warning">추가</button>
            </div>
        </form>
    </div>
    </div>

{% if total_pages and total_pages > 1 %}
<nav aria-label="페이지" class="mt-3">
    <ul class="pagination justify-content-center">
        {% if has_prev %}
        <li class="page-item"><a class="page-link" href="{{ url_for('admin.admin_users', page=page-1) }}">이전</a></li>
        {% endif %}
        <li class="page-item disabled"><span class="page-link">{{ page }} / {{ total_pages }}</span></li>
        {% if has_next %}
        <li class="page-item"><a class="page-link" href="{{ url_for('admin.admin_users', page=page+1) }}">다음</a></li>
        {% endif %}
    </ul>
</nav>
{% endif %}
<!-- 단일 이메일 수정 모달 (동적 바인딩) -->
<div class="modal fade" id="editEmailModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="editEmailForm" class="modal-content" method="post">
            <div class="modal-header">
                <h5 class="modal-title" id="editEmailTitle">이메일 수정</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">새 이메일</label>
                <input type="email" name="email" id="editEmailInput" class="form-control" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="submit" class="btn btn-primary">저장</button>
            </div>
        </form>
    </div>
</div>

<!-- 단일 비밀번호 변경 모달 (동적 바인딩) -->
<div class="modal fade" id="editPwModal" tabindex="-1">
    <div class="modal-dialog">
        <form id="editPwForm" class="modal-content" method="post">
            <div class="modal-header">
                <h5 class="modal-title" id="editPwTitle">비밀번호 변경</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <label class="form-label">새 비밀번호</label>
                <input type="password" name="password" class="form-control mb-2" minlength="6" required>
                <label class="form-label">새 비밀번호 확인</label>
                <input type="password" name="password_confirm" class="form-control" minlength="6" required>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="submit" class="btn btn-success">저장</button>
            </div>
        </form>
    </div>
</div>

{% block extra_scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    var emailModal = document.getElementById('editEmailModal');
    emailModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var userId = button.getAttribute('data-user-id');
        var username = button.getAttribute('data-username');
        var email = button.getAttribute('data-email');
        document.getElementById('editEmailTitle').textContent = '이메일 수정 - ' + username;
        document.getElementById('editEmailInput').value = email || '';
        var form = document.getElementById('editEmailForm');
        form.action = '{{ url_for('admin.admin_update_email', user_id=0) }}'.replace('/0/', '/' + userId + '/');
    });

    var pwModal = document.getElementById('editPwModal');
    pwModal.addEventListener('show.bs.modal', function (event) {
        var button = event.relatedTarget;
        var userId = button.getAttribute('data-user-id');
        var username = button.getAttribute('data-username');
        document.getElementById('editPwTitle').textContent = '비밀번호 변경 - ' + username;
        var form = document.getElementById('editPwForm');
        form.action = '{{ url_for('admin.admin_update_password', user_id=0) }}'.replace('/0/', '/' + userId + '/');
    });
});
</script>
{% endblock %}
{% endblock %}


